<script>
import wepy from 'wepy'
import 'wepy-async-function'
import Promise from 'promise-polyfill'
import host from './config.js'
export default class extends wepy.app {
  config = {
    pages: [
      'pages/index',
      'pages/profile',
      'pages/map',
      'pages/detail',
      'pages/plant'
    ],
    tabBar: {
      selectedColor: "#2ed573",
      backgroundColor: "#ffffff",
      borderStyle:"white",
      list: [{
        pagePath: "pages/index",
        text: "首页",
        iconPath: "resources/home_light.png",
        selectedIconPath: "./resources/home_fill_light.png"
      },{
        pagePath: "pages/map",
        text: "地图",
        iconPath: "./resources/location_light.png",
        selectedIconPath: "resources/location_fill.png"
      },{
        pagePath: "pages/profile",
        text: "我",
        iconPath: "resources/my_light.png",
        selectedIconPath: "resources/my_fill_light.png"
      }]
    },
    window: {
      backgroundTextStyle: 'light',
      navigationBarBackgroundColor: '#fff',
      navigationBarTitleText: 'WeChat',
      navigationBarTextStyle: 'black'
    }
  }

  globalData = {
    userInfo: null,
    all: [],
    index: 0,
    sorted: false,
    orders: 'asc',
    selected: 'hotel',
    plant: [],
    pick: []
  }

  constructor () {
    super()
    this.use('promisify')
    this.use('requestfix')
  }

  // 初始化数据
  onLaunch () {
    this.login()
  }

  // 检查登录是否过期
  checkSession(){
    return new Promise((resolve, reject) => {
      wx.checkSession({
        success:function(){
          resolve(true)
        },
        fail:function(){
          reject('请重新登录')
        }
      })
    })
  }

  // 登录并返回key
  login(){
    var that = this
    return new Promise((resolve,reject) => {
      wx.login({
        success: function(res){
          wx.request({
            url: host.service.loginUrl,
            method: 'POST',
            data: {
              code: res.code
            },
            success: function(res){
              wx.setStorage({
                key:'key',
                data: res.data.key
              })

              that.ajax(host.service.getResUrl, 'POST', { tag: 'all' })
              .then(res => {
                that.globalData.all = res.data
              })
            }
          })
        }
      })
    })
  }

  // 封装登录之后的请求
  ajax(url,method="GET",data,config={}){ 
    //wx.clearStorageSync()
    let key = wx.getStorageSync('key')
    if(!key){
      return new Promise((resolve,reject) => {
        this.login()
        reject('请登录')
      })
    } else {
      return new Promise((resolve,reject) =>{
        this.checkSession().then(_=>{
          if(_){
            wx.request({
              url,
              method:method.toLocaleUpperCase(),
              data,
              header: Object.assign({},{key},config),
              success: (ret) =>{
                resolve(ret.data)
              }
            })
          } else {
            this.login()
            reject('session_key失效')
          }
        })
      })
    }
  }
}
</script>
<style lang="less">
html,body,page{
  height: 100%
}
.container{
  height:100%;
  position:relative
}
.content{
  position: absolute;
  left: 0;
  top: 49px;
  right: 0;
  bottom:0;
}
.container {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
}

@font-face {
    font-family: 'iconfont';
    src: url(data:font/truetype;charset=utf-8;base64,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a3BmUSAIDUBAAAAAAAMAUQAAA68DBQAYAB0ANAAAJT8BPgImJyYHBgcGIicmJyYHDgEeARcBMQc0MhUTNh4CDgEHAQYiJwEuAj4CFxYXNgIMIe4tMgogI0RZS0sGEAZLS1lEIyAKMi0BGwECnTZiUyYLOTL+4wwgDP7jMjkLJlNiNlFNTTch6SxdXlQiQg0MQwUFQwwNQiJUXl0s/uoBAQEC0wggUWZwazD+6QwMARcwa3BmUSAIDUBAAAAAAAASAN4AAQAAAAAAAAAVACwAAQAAAAAAAQAIAFQAAQAAAAAAAgAHAG0AAQAAAAAAAwAIAIcAAQAAAAAABAAIAKIAAQAAAAAABQALAMMAAQAAAAAABgAIAOEAAQAAAAAACgArAUIAAQAAAAAACwATAZYAAwABBAkAAAAqAAAAAwABBAkAAQAQAEIAAwABBAkAAgAOAF0AAwABBAkAAwAQAHUAAwABBAkABAAQAJAAAwABBAkABQAWAKsAAwABBAkABgAQAM8AAwABBAkACgBWAOoAAwABBAkACwAmAW4ACgBDAHIAZQBhAHQAZQBkACAAYgB5ACAAaQBjAG8AbgBmAG8AbgB0AAoAAApDcmVhdGVkIGJ5IGljb25mb250CgAAaQBjAG8AbgBmAG8AbgB0AABpY29uZm9udAAAUgBlAGcAdQBsAGEAcgAAUmVndWxhcgAAaQBjAG8AbgBmAG8AbgB0AABpY29uZm9udAAAaQBjAG8AbgBmAG8AbgB0AABpY29uZm9udAAAVgBlAHIAcwBpAG8AbgAgADEALgAwAABWZXJzaW9uIDEuMAAAaQBjAG8AbgBmAG8AbgB0AABpY29uZm9udAAARwBlAG4AZQByAGEAdABlAGQAIABiAHkAIABzAHYAZwAyAHQAdABmACAAZgByAG8AbQAgAEYAbwBuAHQAZQBsAGwAbwAgAHAAcgBvAGoAZQBjAHQALgAAR2VuZXJhdGVkIGJ5IHN2ZzJ0dGYgZnJvbSBGb250ZWxsbyBwcm9qZWN0LgAAaAB0AHQAcAA6AC8ALwBmAG8AbgB0AGUAbABsAG8ALgBjAG8AbQAAaHR0cDovL2ZvbnRlbGxvLmNvbQAAAgAAAAAAAAAKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZAAAAAQACAFsBAgEDAQQBBQEGAQcBCAEJAQoBCwEMAQ0BDgEPARABEQESARMBFAEVARYFbGlrZTEKYXBwcmVjaWF0ZQlmYXZvcmZpbGwFZmF2b3IMbG9jYXRpb25maWxsBnVuZm9sZAhsaWtlZmlsbARsaWtlBXJpZ2h0B21lc3NhZ2UEZm9sZAxyZWNoYXJnZWZpbGwFc2hhcmUQdHJpYW5nbGVkb3duZmlsbA50cmlhbmdsZXVwZmlsbAtzaGFyZV9saWdodAtmYXZvcl9saWdodA5sb2NhdGlvbl9saWdodAtwaG9uZV9saWdodAZ4aWh1YW4HeGlodWFuMQAAAAAB//8AAgABAAAADAAAABYAAAACAAEAAwAYAAEABAAAAAIAAAAAAAAAAQAAAADVpCcIAAAAANeLSRsAAAAA14tJGw==) format('truetype');
    font-weight: normal;
    font-style: normal;
}


.iconfont {
  font-family:"iconfont" !important;
  font-size:16px;
  font-style:normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-appreciate:before { content: "\e644"; }

.icon-favorfill:before { content: "\e64b"; }

.icon-favor:before { content: "\e64c"; }

.icon-locationfill:before { content: "\e650"; }

.icon-unfold:before { content: "\e661"; }

.icon-likefill:before { content: "\e668"; }

.icon-like:before { content: "\e669"; }

.icon-right:before { content: "\e6a3"; }

.icon-message:before { content: "\e6bc"; }

.icon-fold:before { content: "\e6de"; }

.icon-rechargefill:before { content: "\e6ec"; }

.icon-share:before { content: "\e6f3"; }

.icon-like1:before { content: "\e629"; }

.icon-triangledownfill:before { content: "\e79b"; }

.icon-triangleupfill:before { content: "\e79c"; }

.icon-share_light:before { content: "\e7e0"; }

.icon-favor_light:before { content: "\e7e1"; }

.icon-location_light:before { content: "\e7f3"; }

.icon-xihuan:before { content: "\e86f"; }

.icon-xihuan1:before { content: "\e870"; }

.icon-phone_light:before { content: "\e7fe"; }

.selectarea{
  height:50px;
  position: fixed;
  width: 100%;
  left: 0;
  top: 0;
  background: #fff
}
.nav-left,.nav-right{
  position: absolute;
  height: 50px;
  padding-left: 15px;
  padding-right: 15px;
  top: 0;
  line-height: 50px;
}
.nav-left{
  left:0;
}
.nav-right{
  right:0;
}
</style>
