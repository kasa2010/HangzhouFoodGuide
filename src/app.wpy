<script>
import wepy from 'wepy'
import 'wepy-async-function'
import Promise from 'promise-polyfill'
import host from './config.js'
export default class extends wepy.app {
  config = {
    pages: [
      'pages/index',
      'pages/profile',
      'pages/map',
      'pages/detail'
    ],
    tabBar: {
      selectedColor: "#2ed573",
      backgroundColor: "#ffffff",
      borderStyle:"white",
      list: [{
        pagePath: "pages/index",
        text: "首页",
        iconPath: "resources/home_light.png",
        selectedIconPath: "./resources/home_fill_light.png"
      },{
        pagePath: "pages/map",
        text: "地图",
        iconPath: "./resources/location_light.png",
        selectedIconPath: "resources/location_fill.png"
      },{
        pagePath: "pages/profile",
        text: "我",
        iconPath: "resources/my_light.png",
        selectedIconPath: "resources/my_fill_light.png"
      }]
    },
    window: {
      backgroundTextStyle: 'light',
      navigationBarBackgroundColor: '#fff',
      navigationBarTitleText: 'WeChat',
      navigationBarTextStyle: 'black'
    }
  }

  globalData = {
    userInfo: null,
    all: [],
    index: 0,
    sorted: false,
    orders: 'asc'
    selected: 'hotel',
    plant: [],
    pick: []
  }

  constructor () {
    super()
    this.use('promisify')
    this.use('requestfix')
  }

  // 初始化数据
  onLaunch () {
  
  }

  // 检查登录是否过期
  checkSession(){
    return new Promise((resolve, reject) => {
      wx.checkSession({
        success:function(){
          resolve(true)
        },
        fail:function(){
          reject('请重新登录')
        }
      })
    })
  }

  // 登录并返回key
  login(){
    return new Promise((resolve,reject) => {
      wx.login({
        success: function(res){
          wx.request({
            url: host.service.loginUrl,
            method: 'POST',
            data: {
              code: res.code
            },
            success: function(res){
              console.log(res)
              wx.setStorage({
                key:'key',
                data: res.data.key
              })
            }
          })
        }
      })
    })
  }

  // 封装登录之后的请求
  ajax(url,method="GET",data,config={}){
    let key = wx.getStorageSync('key')
    if(!key){
      return new Promise((resolve,reject) => {
        this.login()
        reject('请登录')
      })
    } else {
      return new Promise((resolve,reject) =>{
        this.checkSession().then(_=>{
          if(_){
            wx.request({
              url,
              method:method.toLocaleUpperCase(),
              data,
              header: Object.assign({},{key},config),
              success: (ret) =>{
                resolve(ret.data)
              }
            })
          } else {
            this.login()
            reject('session_key失效')
          }
        })
      })
    }
  }
}
</script>
<style lang="less">
html,body,page{
  height: 100%
}
.container{
  height:100%;
  position:relative
}
.content{
  position: absolute;
  left: 0;
  top: 49px;
  right: 0;
  bottom:0;
}
.container {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  box-sizing: border-box;
}

@font-face {
    font-family: 'iconfont';
    src: url(data:font/truetype;charset=utf-8;base64,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) format('truetype');
    font-weight: normal;
    font-style: normal;
}

.iconfont {
  font-family:"iconfont" !important;
  font-size:16px;
  font-style:normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-unfold:before { content: "\e661"; }

.icon-pulldown:before { content: "\e69f"; }

.icon-pullup:before { content: "\e6a0"; }

.icon-fold:before { content: "\e6de"; }

.icon-triangledownfill:before { content: "\e79b"; }

.icon-triangleupfill:before { content: "\e79c"; }

.icon-appreciate_light:before { content: "\e7e1"; }

.icon-favor_light:before { content: "\e7e2"; }

.selectarea{
  height:50px;
  position: fixed;
  width: 100%;
  left: 0;
  top: 0;
  background: #fff
}
.nav-left,.nav-right{
  position: absolute;
  height: 50px;
  padding-left: 15px;
  padding-right: 15px;
  top: 0;
  line-height: 50px;
}
.nav-left{
  left:0;
}
.nav-right{
  right:0;
}
</style>
